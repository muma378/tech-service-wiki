.. spec_templates:

=================
标注模板简明指南
=================

数据堂标注平台_ 提供了一系列的标注模板以完成各类标注任务，简单来说，包括 **语音内容转写** ， **街景图片标注** ， **人脸关键点标注** 和 **视频物体追踪** 。我们在这篇文档中将集中介绍以上四种类型的标注任务常用的模板。

不同的客户常常有着定制化的需求，即使同一类型的标注任务也会对应十多种模板，我们不会详细列举所有模板的功能，而是选取每类任务中最基础最通用的模板进行说明，以期帮助大家建立一个全局的印象。

对每类模板的说明我们会按照以下几个方面进行：

* 功能介绍。模板实现的业务功能，包括使用场景、操作界面和基本属性；
* 平台格式。平台相关的索引文件格式和标注导出结果格式说明。需要注意的是，导出格式中通常包含着很多通用字段，如 `_guid` 、 `_id` 、 `_personInProjectId` 、 `Workload` 等。为了使格式显示更加清晰，我们在介绍模板的时候去掉了这些通用字段，而在本篇结尾 :ref:`common_fields_intro` 统一进行说明；
* 交付建议。对这类标注数据序列化，交付客户的最佳格式建议；
* 相关扩展。相似模板及可能引入的修改点。

另外，我们提供了一个基于 **Moose1.0** 的项目 datatang-base_ ，提供针对这几类不同的模板编写代码的思路。

-----------------------------------------

.. _audio-transliterate:

语音内容转写
=============

多段落语音标注v2.1.1
-------------------------

**> 功能介绍**

**多段落语音标注v2.1.1** 提供了对一段音频中每句话的内容进行转写、标定开始和结束时间的功能。利用这些标注信息，数据处理工程师可以将一段音频分割成多个单句，并且提供单句对应的文本内容。

**> 平台格式**

- 索引格式： ::

    {
    "url" : "G4297/IOS0-6.wav",
    "urlList" : ["G4297/IOS_G4297_S0000.wav", "G4297/IOS_G4297_S0001.wav", "G4297/IOS_G4297_S0002.wav",],
    }


- 导出格式：

  Source ::

    {
    "url" : "G4297/IOS0-6.wav",
    "urlList" : ["G4297/IOS_G4297_S0000.wav", "G4297/IOS_G4297_S0001.wav", "G4297/IOS_G4297_S0002.wav",],
    },


  Result ::

    {
    "filename" : "G4300/IOS0-4wav",
    "effective" : "true",
    "markResult" : [{
        "start" : 2.703125,
        "end" : 6.53125,
        "title" : "",
        "extend" : {
          "formValue" : [],
          "content" : "妈妈这（ze4）些小树（su4）苗们在跳舞[N]"
        }
      }, {
        "start" : 7.328125,
        "end" : 10.6875,
        "title" : "",
        "extend" : {
        "content" : "[N]就像做错了什（sen3）么事（si4）[N]",
        "formValue" : []
        }
      },
      ...
      ]
      }


**> 交付建议**

在处理这类数据时，我们建议将每段音频按照时间点切割成单句，并提供与音频名称相同的文本文件——仅包含一行转写内容（无换行符）的.txt文件。

在文件命名上，切割后的文件按照 **原始音频名** + **_S** + **按照起始时间排序从1开始的索引，并用0左补齐** 命名，所有的切割后的文件放在以 **原始音频名（不包含后缀）** 命名的文件夹下，具体文件结构和格式如下：

- 文件结构：

  定制数据 ::

    第XXX期语音标注任务/
        wav_name1/
            wav_name1_S0001.wav
            wav_name1_S0001.txt
            ...
        wav_name2/
            wav_name2_S0001.wav
            wav_name2_S0001.txt
            ...

  自制数据 ::

    data/
        category/
            G0001/
                session_Phone/
                    Phone_G0001_S0001.wav
                    Phone_G0001_S0001.txt
                    Phone_G0001_S0001.metadata
                    ...
                session_Mic/
                    Mic_G0001_S0001.wav
                    Mic_G0001_S0001.txt
                    Mic_G0001_S0001.metadata
                    ...
                ...
            G0002/
            ...

- 文件格式：

  wav_name1_S0001.txt ::

    妈妈这（ze4）些小树（su4）苗们在跳舞[N]


**> 扩展话题**

* 除了语音内容转写，这类模板也可能包含录音人或音频信息的属性标注。如果包含其他属性的标注，则需要属性名称和值行成的.json文件。关于属性名称的选择可以参考本章的 `属性命名参考列表`_ ，文件格式如下：

  wav_name1_S0001.json ::

    {
    "sex": "female",
    "age": 5,
    "content": "妈妈这（ze4）些小树（su4）苗们在跳舞[N]"
    }

*

-----------------------------------------

.. _cityscape_images:

街景图片标注
================

街景矩形框、多边形v3.8
--------------------------------

**> 功能介绍**

**图像线、矩形框、多边形标注v3.0** 提供了一张图片中每个标注物的坐标信息、标注物相关的属性以及标
注物互相之间的关联关系，数据处理工程师可以使用这些坐标信息将标注框还原到图片上，生成不同类型的图像，并且知道标注物质检的关系。

**> 平台格式**

- 索引格式 ::

    url1.jpg
    url2.jpg
    url3.jpg
    ...

- 导出格式

  Source ::

    {
      '_personInProjectId': 0,
      'dataTitle': 'datatang_part2_CH-1_187_1496249231589.jpg',
      'url': 'datatang_part2_CH-1_187_1496249231589.jpg',
      '_guid': 'ad8db6c3-73b4-413b-97cb-4476bdbfd383',
      '_createTime': '2017/9/2210: 05: 48',
      '_id': ObjectId('c3b68dadb4733b4197cb4476')
    }

  Result ::

    {
      '_personInProjectId': 476583,
      'workload': {
        'roadsignCount': '0',
        'selfqualifiedboxcount': 0,
        'rectCount': '0',
        'boxcount': 8,
        'workTime': 0.9853166666666666,
        'polygonCount': '0',
        'selfunqualifiedboxcount': 0,
        'unqualifiedboxcount': 0,
        'lineCount': '8',
        'trafficlightCount': '0',
        'total': '8',
        'qualifiedboxcount': 0
      },
      'effective': 1,
      '_guid': '11828c89-8b10-4b2a-858e-766d821be151',
      '_createTime': '2017/9/2813: 51: 52',
      'markResult': {
      'type': 'FeatureCollection',
      'features': [{
        'geometry': {
          'type': 'LineString',
          'coordinates': [[606.8049645037071,
          297.8348053163902],
          [545.8049645037071,
          311.3348053163902],
          [327.3049645037071,
          356.8348053163902],
          [161.80496450370708,
          395.3348053163902],
          [4.804964503707083,
          436.3348053163902]]
        },
        'type': 'Feature',
        'properties': {
          'type': {
            'parentDataKey': 'whitedashed',
            'currentDataKey': 'parallel',
            'currentDataTitle': '纵向',
            'parentDataTitle': '白色虚线'
          },
          'quality': {
            
          },
          'index': 1
        },
        'title': '1-白色虚线-纵向'
      }]
    }

**> 交付建议**

这类数据我们建议提供与图片名称相同的.txt文件，文件内容包含标注的坐标点信息、标注框的id和客户想要的标注物属性，并且都以json格式进行导出，同时提供对应的原始图片、mask图以及blend图。
具体文件结构格式如下：

- 文件结构:
  
  定制数据 ::

    第XXX期图片标注任务/
        img_name1/
            img_name1_S0001.jpg
            img_name1_S0001.txt
            img_name1_S0001_mask.jpg
            img_name1_S0001_blend.jpg
            ...
        img_name2/
            img_name2_S0001.jpg
            img_name2_S0001.txt
            img_name2_S0001_mask.jpg
            img_name2_S0001_blend.jpg
            ...

  自制数据 ::

    data/
        category/
            G0001/
                session_jpg/
                    imgname_G0001_S0001.jpg
                    imgname_G0001_S0001.txt
                    imgname_G0001_S0001.metadata
                    imgname_G0001_S0001_mask.jpg
                    imgname_G0001_S0001_blend.jpg
                    ...
                session_png/
                    imgname_G0001_S0001.png
                    imgname_G0001_S0001.txt
                    imgname_G0001_S0001.metadata
                    imgname_G0001_S0001_mask.png
                    imgname_G0001_S0001_blend.png
                    ...
                ...
            G0002
            ...

- 文件格式 :
  
  img_name1_S0001.txt ::
      "filename": "img_name1_S0001.jpg",
      "datalist": [{
              
              "arr": [{
                  "x": 606.8049645037071,
                  "y": 297.8348053163902
                  },
                  {
                  "x": 545.8049645037071,
                  "y": 311.3348053163902
                  },
                    ...
              ],
              "id": 1,
              "type": "dotted line",
              "pro1": xxxx,
              "pro2": xxxx,
              ...
          {
              ...
          }
          ...
    }]

**> 扩展话题**

* 这类模板也可能包括各标注物之间的关联关系，一般在导出数据中包含 **relativeAssis** 或者 **link** 这样的属性字段，里面包含其所关联的父标注物id,例如 
  ::
    "link":{
        "linkId": 10,
        "linkTitle": "轿车",
        "val": "10-轿车
        }
  表示其关联id为10的轿车，
  ::
    "relativaAssis": 4 
  表示其关联id为4的标注物

* 同时这类模板可能会被要求导出标注框的总数以及标注的不同类型框的数量，具体信息可以参照本章的 `属性命名参考列表`_, 但是导出结果数据可能不太准确，所以建议自己计算出数量导出,文件导出格式参照上面 **文件格式**
-----------------------------------------

.. _face_keypoints:

人脸关键点标注
================

人脸106关键点标注v2.0
----------------------

**> 功能介绍**


**> 平台格式**


**> 交付建议**


**> 扩展话题**

-----------------------------------------

.. _objects_tracking:

视频物体追踪
================

单镜头街景标注v1.6
----------------------

**> 功能介绍**


**> 平台格式**


**> 交付建议**


**> 扩展话题**


------------------------------------------


.. _common_fields_intro:

平台通用字段说明
================

每个模板都包含一些通用字段，它们通常由系统自动生成，并与SQL数据库中的某个字段相同，便于交叉查询。在系统中，每条数据对应 **Source** 和 **Result** 两个集合（collection），分别代表这条数据的原始信息（标注前）和标注信息（标注后），因此，我们在每个字段后用等宽文本（monospaced text）来注明这个字段所在的集合。

_guid ``Source`` ``Result``
    每条数据的全局唯一标识符， ``Source`` 中的_guid与SQL数据库中 ``DataSource`` 表中的 `DataGuid` 和 ``DataResult`` 表中的 `SourceGuid` 一致， ``Result`` 中的_guid与SQL数据库中 ``DataResult`` 表中的 `DataGuid` 一致。

_personInProjectId ``Result``
    该数据标注人员的在项目中的ID，与SQL数据库中 ``PersonInProject`` 表中的 `id` 一致。

_id ``Source`` ``Result``
    MongoDB中插入数据时自动生成的唯一值。

_createTime ``Source`` ``Result``
    该条数据被创建的时间。

Workload ``Result``
    对标注各个类别的数量统计（不准，不建议使用）。

markCount ``Result``
    标注数量的统计。

url ``Source``
    原始文件在云平台上面的相对路径

effective ``Result``
    标注结果是否有效(1 表示有效)

markResult ``Result``
    总标注结果数据(包括坐标点和属性值)

geometry ``Result``
    每一个框的坐标点(每一个列表分别有两个坐标值，分别代表 **x** 和 **y** )

properties ``Result``
    每一个框的属性值

-----------------------------------------


.. _naming_reference:

属性命名参考列表
==================

因为客户对标注属性的选择不一，各模板产生的字段也不尽不同，我们无法提供一个统一的格式来覆盖所有的可能数据集。但是，我们在此提供了一个属性命名参考列表，避免不同项目中同一含义的属性使用多套命名规则：

+-------------------+-----------------+
|导出属性名称       | 属性命名        |
+===================+=================+
| filename          | 文件名          |
+-------------------+-----------------+
| prop              | 标注属性列表    |
+-------------------+-----------------+
| arr               | 坐标点列表      |
+-------------------+-----------------+
| id                | 标注框id        |
+-------------------+-----------------+
| sex               | 性别            |
+-------------------+-----------------+
| age               | 年龄            |
+-------------------+-----------------+
| parentId          | 关联id          |
+-------------------+-----------------+
| solid             | 实线            |
+-------------------+-----------------+
| dashed            | 虚线            |
+-------------------+-----------------+
| dotted            | 点线            |
+-------------------+-----------------+
|                   |                 |
+-------------------+-----------------+
| content           | 文本内容        |
+-------------------+-----------------+
|                   |                 |
+-------------------+-----------------+
|                   |                 |
+-------------------+-----------------+
|                   |                 |
+-------------------+-----------------+










.. _数据堂标注平台: http://bz.datatang.com/
.. _datatang-base: http://git.datatang.com/xiaoyang/datatang_base
